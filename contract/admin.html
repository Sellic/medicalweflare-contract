<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>계약서 관리 - 메디컬웰페어</title>
  <style>
    body {
      font-family: '맑은 고딕', sans-serif;
      background: #f9f9f9;
      color: #333;
      padding: 30px;
      line-height: 1.6;
      max-width: 1200px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .admin-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .contracts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .contracts-table th,
    .contracts-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .contracts-table th {
      background: #f5f5f5;
      font-weight: bold;
    }
    .contracts-table tr:hover {
      background: #f9f9f9;
    }
    .button {
      background: #0077cc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 5px;
    }
    .button:hover {
      background: #005fa3;
    }
    .button.danger {
      background: #dc3545;
    }
    .button.danger:hover {
      background: #c82333;
    }
    .button.success {
      background: #28a745;
    }
    .button.success:hover {
      background: #218838;
    }
    .status-message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .nav-links {
      text-align: center;
      margin-bottom: 20px;
    }
    .nav-links a {
      color: #0077cc;
      text-decoration: none;
      margin: 0 10px;
      padding: 8px 16px;
      border: 1px solid #0077cc;
      border-radius: 4px;
    }
    .nav-links a:hover {
      background: #0077cc;
      color: white;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    .stat-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #0077cc;
    }
  </style>
</head>
<body>
  <h1>계약서 관리 시스템</h1>
  <h2>메디컬웰페어 플랫폼</h2>

  <div class="nav-links">
    <a href="/">계약서 작성</a>
    <a href="/admin">계약서 관리</a>
  </div>

  <div class="admin-container">
    <div class="stats">
      <div class="stat-box">
        <div class="stat-number" id="totalContracts">0</div>
        <div>총 계약서</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="thisMonth">0</div>
        <div>이번 달</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="totalSize">0 MB</div>
        <div>총 용량</div>
      </div>
    </div>

    <div id="statusMessage"></div>

    <button class="button success" onclick="refreshContracts()">새로고침</button>
    <button class="button" onclick="downloadAll()">전체 다운로드</button>

    <table class="contracts-table">
      <thead>
        <tr>
          <th>파일명</th>
          <th>업체명</th>
          <th>이메일</th>
          <th>대표자명</th>
          <th>업로드 날짜</th>
          <th>파일 크기</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="contractsTableBody">
        <tr>
          <td colspan="7" style="text-align: center;">로딩 중...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    function showStatus(message, isSuccess = true) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = `status-message ${isSuccess ? 'status-success' : 'status-error'}`;
      
      setTimeout(() => {
        statusDiv.textContent = '';
        statusDiv.className = '';
      }, 5000);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR');
    }

    async function loadContracts() {
      try {
        const response = await fetch('/contracts');
        const result = await response.json();

        if (result.success) {
          displayContracts(result.contracts);
          updateStats(result.contracts);
        } else {
          showStatus('계약서 목록을 불러오는데 실패했습니다: ' + result.message, false);
        }
      } catch (error) {
        console.error('계약서 로드 오류:', error);
        showStatus('서버 연결에 실패했습니다.', false);
      }
    }

    function displayContracts(contracts) {
      const tbody = document.getElementById('contractsTableBody');
      
      if (contracts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">저장된 계약서가 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = contracts.map(contract => {
        return `
          <tr>
            <td>${contract.filename}</td>
            <td>${contract.partnerName || ''}</td>
            <td>${contract.partnerEmail || ''}</td>
            <td>${contract.partnerRepresentative || ''}</td>
            <td>${formatDate(contract.uploadDate)}</td>
            <td>${formatFileSize(contract.size)}</td>
            <td>
              <button class="button" onclick="downloadContract('${contract.filename}')">다운로드</button>
              <button class="button danger" onclick="deleteContract('${contract.filename}')">삭제</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats(contracts) {
      const totalContracts = contracts.length;
      const thisMonth = contracts.filter(contract => {
        const contractDate = new Date(contract.uploadDate);
        const now = new Date();
        return contractDate.getMonth() === now.getMonth() && 
               contractDate.getFullYear() === now.getFullYear();
      }).length;
      
      const totalSize = contracts.reduce((sum, contract) => sum + contract.size, 0);

      document.getElementById('totalContracts').textContent = totalContracts;
      document.getElementById('thisMonth').textContent = thisMonth;
      document.getElementById('totalSize').textContent = formatFileSize(totalSize);
    }

    async function downloadContract(filename) {
      try {
        window.open(`/download/${encodeURIComponent(filename)}`, '_blank');
      } catch (error) {
        console.error('다운로드 오류:', error);
        showStatus('다운로드에 실패했습니다.', false);
      }
    }

    async function deleteContract(filename) {
      if (!confirm(`정말로 "${filename}" 파일을 삭제하시겠습니까?`)) {
        return;
      }

      try {
        const response = await fetch(`/delete/${encodeURIComponent(filename)}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('파일이 성공적으로 삭제되었습니다.');
          loadContracts(); // 목록 새로고침
        } else {
          showStatus('파일 삭제에 실패했습니다: ' + result.message, false);
        }
      } catch (error) {
        console.error('삭제 오류:', error);
        showStatus('삭제 중 오류가 발생했습니다.', false);
      }
    }

    async function downloadAll() {
      try {
        const response = await fetch('/contracts');
        const result = await response.json();

        if (result.success && result.contracts.length > 0) {
          result.contracts.forEach(contract => {
            setTimeout(() => {
              downloadContract(contract.filename);
            }, 500); // 0.5초 간격으로 다운로드
          });
          showStatus('모든 파일 다운로드를 시작했습니다.');
        } else {
          showStatus('다운로드할 파일이 없습니다.', false);
        }
      } catch (error) {
        console.error('전체 다운로드 오류:', error);
        showStatus('전체 다운로드에 실패했습니다.', false);
      }
    }

    function refreshContracts() {
      loadContracts();
    }

    // 페이지 로드 시 계약서 목록 불러오기
    document.addEventListener('DOMContentLoaded', loadContracts);
  </script>
</body>
</html> 